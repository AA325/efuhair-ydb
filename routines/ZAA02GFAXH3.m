ZAA02GFAXH3 ;PG&A,ZAA02G-FAX,1.36,MH OVERLAY;19JUL96 3:48P
 ;Copyright (C) 1991-1994, Patterson, Gray and Associates Inc.
 ;
 ;
CVT S MG=0,CVR=0,CUT=1 F Z=.03:0 S Z=$O(@ZAA02GFAXD@(Z)) Q:Z=""  I $D(^(Z))#2 S TXT=$E(^(Z),CUT,255) D LINE
 D CVT1
 S TFXL=TFXL+FXL,$P(@ZAA02GFAXS@(PG),",")=FXL,PGN=PG,@ZAA02GFAXS=+$H_","_TFXL_","_PG G:$D(CVRP) CVR^ZAA02GFAXH1 K CUT Q
CVT1 I $D(@OVR@(FXL+1)) S TXT="",TXL=0,TXR=1,TXW=1728-(MG+CVR) F FXL=FXL:0 Q:'$D(@OVR@(FXL+1))  D LN1 H 0
 Q
 ;
LINE I (TXT["~P") D CVT1 S PG=PG+1,TFXL=TFXL+FXL,PGL=SPGL,$P(@ZAA02GFAXS@(PG-1),",")=FXL,FXL=0 Q
 G:TXT["~FAX" GR^ZAA02GFAXH1 G:$D(MF) ^ZAA02GFAXH4 I TXT'[XS S TXT=$TR(TXT,CA,CB),TXL=$L(TXT),TXW=1728-(TXL*FC+MG+CVR) G:TXW<0 LINEL F TXR=1:1:FR D LN1 H 0
 I TXT[XS D VIDEO S TXL=$L(TXT),TXW=1728-(TXL-$L(TXT,$C(0))+1*FC+MG+CVR) G:TXW<0 LINEL F TXR=1:1:FR D LN H 0
 I HP S TXT="",TXL=0,TXW=1728-(MG+CVR) F FXL=FXL:0:11-TXR+FXL D LN1 H 0
 Q
LINEL S TXT=$E(TXT,1,$L(TXT)-2) G LINE
 ;
LN S D=@OVR@(FXL+1),LX=$P(D,";",5,99),L=$P(D,";",4),W=$P(D,";",2),TXD=TXW-D-W D:$P(D,";",3)'="" SET S D=0 D CF
 F I=1:1:TXL S X=TR($A(NTX,I)),W=W+X D:X=0 CF I X["," S L=L_$S(W<32:wht(W),1:^ZAA02GFAXC(.1,W))_$P(X,",",2),W=$P(X,",",3) D:$L(L)>32 LSX
 S W=W+TXD,FNT=FNT(0) G BLN:W>1728 S L=L_$S(W<32:wht(W),1:^ZAA02GFAXC(.1,W))_TRL
 S L=L_$E("00000000",1,-$L(L)#8) D LS,LE:LX[$C(16) S FXL=FXL+1,@ZAA02GFAXS@(PG,FXL)=LX Q
CF S FNT=FNT(D),D=D+1,NTX=$TR(TXT,AL,^ZAA02GFAXF(FNT,.1,TXR)) Q
 ;
LN1 S D=@OVR@(FXL+1),LX=$P(D,";",5,99),L=$P(D,";",4),W=$P(D,";",2),TXD=TXW-D-W D:$P(D,";",3)'="" SET S D=0,NTX=$TR(TXT,AL,^ZAA02GFAXF(FNT,.1,TXR))
 F I=1:1:TXL S X=TR($A(NTX,I)),W=W+X I X["," S L=L_$S(W<32:wht(W),1:^ZAA02GFAXC(.1,W))_$P(X,",",2),W=$P(X,",",3) D:$L(L)>32 LSX
 S W=W+TXD G BLN:W>1728,BLN:W<0 S L=L_$S(W<32:wht(W),1:^ZAA02GFAXC(.1,W))_TRL
 S L=L_$E("00000000",1,-$L(L)#8) D LS,LE:LX[$C(16) S FXL=FXL+1,@ZAA02GFAXS@(PG,FXL)=LX Q
 ;
BLN S J=$D(@ZAA02GFAXS@(PG,FXL)) F FXL=FXL+1:1:FXL+FR S ^(FXL)=""
 Q
SET S I=CVR X $P(D,";",3) S TXW=TXW-CVR+I,TXD=TXD-CVR+I Q
LS F i=1:8:$L(L)\8*8 S LX=LX_$C(B($E(L,i,i+3))+C($E(L,i+4,i+7)))
 S L=$E(L,$L(L)>7*(i+8),255) Q
LSX S LX=LX_$C(B($E(L,1,4))+C($E(L,5,8)))_$C(B($E(L,9,12))+C($E(L,13,16)))_$C(B($E(L,17,20))+C($E(L,21,24)))_$C(B($E(L,25,28))+C($E(L,29,32))),L=$E(L,33,255) Q
 ;
VIDEO S F=ZAA02G("gon"),C="",FNT(0)=FNT,(W,X)=0 F L=1:1:$L(TXT,F) S J=$P(TXT,F) D:J[XS V1 S C=C_$TR(J,CA,CB),J=$P($P(TXT,F,2,99),ZAA02G("gof")) D:J[XS V1 S TXT=$P(TXT,ZAA02G("gof"),2,99),C=C_$TR(J,CD,CE)
 S TXT=C Q
V1 I J[ZAA02G("fon") F T=2:1:$L(J,ZAA02G("fon")) S J=$P(J,ZAA02G("fon"))_" "_$P(J,ZAA02G("fof"),2,99)
 F T=1:1:$L(J,XS)-1 S I=$P(J,XS,2),E=$F(XL,$E(XS_I,1,XSL))\XSL S J=$P(J,XS)_$S(E:$C(0),1:"")_$E($P(J,XS,2,99),XSL,255) I E S X=$S(E=1:X>1*2+1,E=2:X>1*2,E=3:X#2+2,1:X#2),W=W+1,FNT(W)=FNT+X
 Q
LE F E=1:2:$L(LX,$C(16))-1*2 S $P(LX,$C(16),E)=$P(LX,$C(16),E)_$C(16)
 Q
