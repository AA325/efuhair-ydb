ZAA02GFAXHJ ;PG&A,ZAA02G-FAX,1.36,MH ENCODING FOR 2-BYTE KANJI;29NOV95 9:07A
 ;Copyright (C) 1994, Patterson, Gray and Associates Inc.
 ;
CVT S C1="" F J=129:1:159,224:1:252 S C1=C1_$C(J)
 D GETFNT I $P(B,"\",15)'="","YyPpSs"[$P(B,"\",15) D CVR,GETFNT S TXT=$S("YySs"[$P(B,"\",15):"~P",1:"") D LINE
 I $D(OVR) D OVR1^ZAA02GFAXH1 S A=$O(@OVR@(0)) I A S Z=.03 G ^ZAA02GFAXH5:$D(^(A))=11,^ZAA02GFAXH3
 F Z=.03:0 S Z=$O(@ZAA02GFAXD@(Z)) Q:Z=""  I $D(^(Z))#2 S TXT=^(Z) D LINE
 S TFXL=TFXL+FXL,@ZAA02GFAXS@(PG)=FXL,PGN=PG,@ZAA02GFAXS=+$H_","_TFXL_","_PG G:$D(CVRP) CVR Q
 ;
LINE I FXL>PGL!(TXT["~P") S PG=PG+1,TFXL=TFXL+FXL,PGL=SPGL,@ZAA02GFAXS@(PG-1)=FXL,FXL=0 Q:TXT["~P"
 G BLN:TXT="",GR^ZAA02GFAXH1:TXT["~FAX" G:$D(MF) ^ZAA02GFAXHJ2 D SCAN I TXT'[XS S TXT=$TR(TXT,CA,CB),TXL=$L(TXT),TXW=1728-(TXL*FC+MG+CVR) G:TXW<0 LINEL F TXR=1:1:$S($D(SC):19,1:FR) D LN1 H 0
 I TXT[XS D VIDEO S TXL=$L(TXT),TXW=1728-(TXL-$L(TXT,$C(0))+1*FC+MG+CVR) G:TXW<0 LINEL F TXR=1:1:$S($D(SC):19,1:FR) D LN H 0
 I HP F FXL=FXL+1:1:HP-TXR+FXL S @ZAA02GFAXS@(PG,FXL)=""
 Q
LINEL S TXT=$E(TXT,1,$L(TXT)-2) G LINE
 ;
LN S LX="",L=EOL,W=MG,D=0 D CF
 F I=1:1:TXL S X=TR($A(NTX,I)),W=W+X D:X=0 CF I X["," S L=L_$S(W<32:wht(W),1:^ZAA02GFAXC(.1,W))_$P(X,",",2),W=$P(X,",",3) D:$L(L)>32 LSX
 S W=W+TXW,FNT=FNT(0),L=L_$S(W<32:wht(W),W<1729:^ZAA02GFAXC(.1,W),1:wht(0))_TRL D:$L(L)>32 LSX
 S L=L_$E("00000000",1,-$L(L)#8) D LS,LE:LX[$C(16) S FXL=FXL+1,@ZAA02GFAXS@(PG,FXL)=LX Q
CF S FNT=FNT(D),D=D+1,NTX=$TR(TXT,AL,^ZAA02GFAXF(FNT,.1,TXR)) Q
 ;
SCAN K SC Q:$TR(TXT,C1)=TXT  F J=1:1:$L(TXT) I C1[$E(TXT,J) S SC(J)=$G(^ZAA02GFAXJ($A(TXT,J)*256+$A(TXT,J+1))),J=J+1
 Q
LN1 S LX="",L=EOL,W=MG,NTX=$S(TXR<17:$TR(TXT,AL,^ZAA02GFAXF(FNT,.1,TXR)),1:$TR($J("",TXL),AL,^ZAA02GFAXF(FNT,.1,1)))
 F I=1:1:TXL S X=TR($A(NTX,I)),W=W+X S:$D(SC(I)) W=W-X,X=$S($P(SC(I),",",TXR):^ZAA02GFAXJ(0,$P(SC(I),",",TXR)),1:32),W=W+X,I=I+1 I X["," S L=L_$S(W<32:wht(W),1:^ZAA02GFAXC(.1,W))_$P(X,",",2),W=$P(X,",",3) D:$L(L)>32 LSX
 S W=W+TXW,L=L_$S(W<32:wht(W),W<1729:^ZAA02GFAXC(.1,W),1:wht(0))_TRL
 S L=L_$E("00000000",1,-$L(L)#8) D LSX:$L(L)>32,LS,LE:LX[$C(16) S FXL=FXL+1,@ZAA02GFAXS@(PG,FXL)=LX Q
 ;
BLN S J=$D(@ZAA02GFAXS@(PG,FXL)) F FXL=FXL+1:1:FXL+FR S ^(FXL)=""
 Q
LS F i=1:8:$L(L)\8*8 S LX=LX_$C(B($E(L,i,i+3))+C($E(L,i+4,i+7)))
 S L=$E(L,$L(L)>7*(i+8),255) Q
LSX S LX=LX_$C(B($E(L,1,4))+C($E(L,5,8)))_$C(B($E(L,9,12))+C($E(L,13,16)))_$C(B($E(L,17,20))+C($E(L,21,24)))_$C(B($E(L,25,28))+C($E(L,29,32))),L=$E(L,33,255) Q
 ;
VIDEO S F=ZAA02G("gon"),C="",FNT(0)=FNT,(W,X)=0 F L=1:1:$L(TXT,F) S J=$P(TXT,F) D:J[XS V1 S C=C_$TR(J,CA,CB),J=$P($P(TXT,F,2,99),ZAA02G("gof")) D:J[XS V1 S TXT=$P(TXT,ZAA02G("gof"),2,99),C=C_$TR(J,CD,CE)
 S TXT=C Q
V1 I J[ZAA02G("fon") F T=2:1:$L(J,ZAA02G("fon")) S J=$P(J,ZAA02G("fon"))_" "_$P(J,ZAA02G("fof"),2,99)
 F T=1:1:$L(J,XS)-1 S I=$P(J,XS,2),E=$F(XL,$E(XS_I,1,XSL))\XSL S J=$P(J,XS)_$S(E:$C(0),1:"")_$E($P(J,XS,2,99),'E+XSL,255) I E S X=$S(E=1:X>1*2+1,E=2:X>1*2,E=3:X#2+2,1:X#2),W=W+1,FNT(W)=FNT+X
 Q
LE F E=1:2:$L(LX,$C(16))-1*2 S $P(LX,$C(16),E)=$P(LX,$C(16),E)_$C(16)
 Q
 ;
CVR N EOL,MG,TRL,CVR,FNT S MG=20,CVR=536,EOL=^ZAA02GFAXC(0,2,0)_"01101110001001110",TRL="1001011100001011",FNT=$S($D(CVRP):20,1:30) D GETFNT G:$D(CVRP) CVRP
 S Y=$O(^ZAA02GFAXC(98,"")),Y=$S(Y="":1,1:^(Y)),Y=$S($D(^ZAA02GFAXC(99,0,Y,2)):^(2),1:"FROM\TO\SUBJ\Page\of")
 S CG=$P(^ZAA02GFAXC("CONFIG"),"\",3),OFXL=FXL I $E(CG)="^",$D(@CG) S PGL=PGL-$S($D(@CG)#2:@CG,1:0)
 S TXT=" " D LINE S TXT=$P(Y,"\")_":"_$J("",5-$L($P(Y,"\")))_$P(B,"\",11),E="FAX: "_$J($P(B,"\",12),15),TXT=TXT_$J(E,71-$L(TXT)) D LINE
 I $P(^ZAA02GFAXC("CONFIG"),"\")'="" S TXT="      "_$P(^("CONFIG"),"\") D LINE
 S TXT=" " D LINE S TXT=$P(Y,"\",2)_":"_$J("",5-$L($P(Y,"\",2)))_$P(B,"\",13),E="FAX: "_$J($P(B,"\",4),15),TXT=TXT_$J(E,71-$L(TXT)) D LINE
 I $P(B,"\",32)'="" S TXT="      "_$P(B,"\",32) D LINE
 I $P(B,"\",31)'="" S TXT=" " D LINE S TXT=$P(Y,"\",3)_": "_$P(B,"\",31) D LINE
 S TXT=" " D LINE S CVRP=FXL S TXT=" " D LINE
 S TXT=$C(0,0,104,71,6,110,160,166,67,3,0) F FXL=FXL+1:1:FXL+2 S @ZAA02GFAXS@(PG,FXL)=TXT
 S PGL=PGL-FXL+OFXL K OFXL Q
CVRP S TXT=$J("",31)_$P(Y,"\",4)_" 1 "_$P(Y,"\",5)_" "_PG,PG=1,FXL=CVRP-4,HP=0 D LINE Q
 ;
GETFNT D GETFNT^ZAA02GFAXH1
